<% if notice %>
  <div class="notice" style="background-color: #d4edda; color: #155724; padding: 10px; margin-bottom: 15px; border-radius: 4px;">
    <%= notice %>
  </div>
  <script>
    setTimeout(() => {
      const notice = document.querySelector('.notice');
      notice.style.transition = 'opacity 0.5s';
      notice.style.opacity = '0';
      setTimeout(() => {
        notice.remove();
      }, 500);
    }, 1500);
  </script>
<% end %>

<h1>Washington Memorial Map</h1>

<div style="display: flex; gap: 20px;">
  <div id="map" style="width: 60%; height: 500px;"></div>
  
  <div id="entries-list" style="width: 40%; height: 500px; overflow-y: auto; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
    <h2>Memorial Entries</h2>
    <ul id="entries-list-items" style="list-style: none; padding: 0;">
      <!-- Entries will be populated by JavaScript -->
    </ul>
  </div>
</div>

<div style="margin-top: 15px;">
  <%= link_to "Add New Entry", new_map_entry_path, style: "display: inline-block; background-color: #4CAF50; color: white; padding: 8px 16px; text-decoration: none; border-radius: 4px;" %>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<%= javascript_include_tag "application", "data-turbo-track": "reload" %>

<script>
  document.addEventListener('turbo:load', function() {
    initMap();
  });
  
  document.addEventListener('DOMContentLoaded', function() {
    initMap();
  });
  
  function initMap() {
    // Washington State boundaries (approximate)
    const waBounds = [
      [45.5, -124.8], // Southwest corner
      [49.0, -116.9]  // Northeast corner
    ];
    
    // Create map with fixed bounds
    const map = L.map('map', {
      maxBounds: [
        [44.5, -125.8], // Add some padding
        [50.0, -115.9]
      ],
      maxBoundsViscosity: 1.0 // Keep the map within bounds
    }).fitBounds(waBounds);
    
    // Set min/max zoom levels
    map.setMinZoom(6);
    map.setMaxZoom(13);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);
    
    const entriesList = document.getElementById('entries-list-items');
    
    // Fetch map entries from the server
    fetch('/map_entries.json')
      .then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        return response.json();
      })
      .then(entries => {
        console.log('Entries loaded:', entries);
        
        // Clear existing entries list
        entriesList.innerHTML = '';
        
        if (entries.length === 0) {
          entriesList.innerHTML = '<li style="padding: 10px;">No entries yet. Add your first memorial!</li>';
        }
        
        entries.forEach(entry => {
          // Create marker
          const marker = L.marker([entry.latitude, entry.longitude], {
            title: entry.title
          }).addTo(map)
            .bindPopup(`<b>${entry.title}</b><br>${entry.description}`);
          
          // Create list item
          const listItem = document.createElement('li');
          listItem.style.padding = '10px';
          listItem.style.borderBottom = '1px solid #eee';
          listItem.style.display = 'flex';
          listItem.style.justifyContent = 'space-between';
          listItem.style.alignItems = 'center';
          
          // Create content div for title and description
          const contentDiv = document.createElement('div');
          contentDiv.style.cursor = 'pointer';
          contentDiv.style.flexGrow = '1';
          contentDiv.innerHTML = `
            <div style="font-weight: bold;">${entry.title}</div>
            <div style="font-size: 0.9em; color: #666; margin-top: 5px;">${entry.description.substring(0, 100)}${entry.description.length > 100 ? '...' : ''}</div>
          `;
          
          // Create delete button
          const deleteButton = document.createElement('button');
          deleteButton.textContent = 'Delete';
          deleteButton.style.backgroundColor = '#dc3545';
          deleteButton.style.color = 'white';
          deleteButton.style.border = 'none';
          deleteButton.style.borderRadius = '4px';
          deleteButton.style.padding = '5px 10px';
          deleteButton.style.cursor = 'pointer';
          deleteButton.style.marginLeft = '10px';
        
          deleteButton.addEventListener('click', function(e) {
            e.stopPropagation(); // Prevent triggering the list item click
            
            // Call the showDeleteModal function from your imported module
            window.showDeleteModal(entry.id, marker, listItem, map);
          });

          // Add hover effect to content div
          contentDiv.addEventListener('mouseenter', function() {
            listItem.style.backgroundColor = '#f5f5f5';
            
            // Highlight the marker
            marker.setZIndexOffset(1000);
            
            // Open the popup
            marker.openPopup();
            
            // Pan to the marker
            map.panTo(marker.getLatLng());
          });
          
          contentDiv.addEventListener('mouseleave', function() {
            listItem.style.backgroundColor = 'transparent';
            marker.setZIndexOffset(0);
            marker.closePopup();
          });
          
          // Click to zoom to the marker
          contentDiv.addEventListener('click', function() {
            map.setView(marker.getLatLng(), 10);
            marker.openPopup();
          });
          
          // Append elements to list item
          listItem.appendChild(contentDiv);
          listItem.appendChild(deleteButton);
          entriesList.appendChild(listItem);
        });
      })
      .catch(error => {
        console.error('Error loading map entries:', error);
        entriesList.innerHTML = '<li style="color: red; padding: 10px;">Error loading entries</li>';
      });
  }
  
</script>

<div id="delete-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
  <div style="background-color: white; padding: 20px; border-radius: 8px; width: 400px; max-width: 90%; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
    <h3 style="margin-top: 0; color: #333;">Confirm Deletion</h3>
    <p>Are you sure you want to delete this memorial entry? This action cannot be undone.</p>
    <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
      <button id="cancel-delete" style="background-color: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Cancel</button>
      <button id="confirm-delete" style="background-color: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Delete</button>
    </div>
  </div>
</div>